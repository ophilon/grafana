<!DOCTYPE html>
<h1 id="create-lbac-for-data-source-rule">Create LBAC for data source rule</h1>
<p>LBAC for data sources is available for LBAC-supported data sources created with basic authentication. As of today, managed/provisioned data source can <strong>NOT</strong> be configured with LBAC rules.</p>
<h2 id="before-you-begin">Before you begin</h2>
<ul>
<li>Be sure that you have the permission setup to create a Loki tenant in Grafana Cloud.</li>
<li>Be sure that you have admin data source permissions for Grafana.</li>
<li>Be sure that you have a team setup in Grafana.</li>
</ul>
<h3 id="create-a-lbac-for-data-sources-rule-for-a-team">Create a LBAC for data sources rule for a team</h3>
<ol>
<li>Navigate to your data source</li>
<li>Navigate to the permissions tab
<ul>
<li>Here, you&rsquo;ll find the LBAC for data sources rules section.</li>
</ul>
</li>
<li>Add a LBAC for data sources Rule
<ul>
<li>Add a new rule for the team in the LBAC for data sources rules section.</li>
</ul>
</li>
<li>Define a label selector for the rule
<ul>
<li>Add a label selector to the rule. Refer to documentation for guidance on the types of log selections you can specify.</li>
</ul>
</li>
</ol>
<h3 id="lbac-rule">LBAC rule</h3>
<p>An LBAC rule is a <code>logql</code> query that filters logs or metrics based on labels. Each rule operates independently as its own filter, separate from other rules within a team.</p>
<p>For example:</p>
<ul>
<li>For logs: <code>{namespace=&quot;dev&quot;, cluster=&quot;us-west-0&quot;}</code> filters log lines matching both <code>namespace=&quot;dev&quot;</code> and <code>cluster=&quot;us-west-0&quot;</code>.</li>
<li>For metrics: <code>{job=&quot;api-server&quot;, region=&quot;europe&quot;}</code> filters metric data points matching <code>job=&quot;api-server&quot;</code> and <code>region=&quot;europe&quot;</code>.</li>
</ul>
<p>One rule <code>{namespace=&quot;dev&quot;, cluster=&quot;us-west-0&quot;}</code> created with multiple namespaces will be seen as <code>namespace=&quot;dev&quot;</code> <strong>AND</strong> <code>cluster=&quot;us-west-0&quot;</code>.
Two rules <code>{namespace=&quot;dev&quot;}</code>, <code>{cluster=&quot;us-west-0&quot;}</code> created for a team will be seen as <code>namespace=&quot;dev&quot;</code> <strong>OR</strong> <code>cluster=&quot;us-west-0&quot;</code>.</p>
<h4 id="best-practices">Best practices</h4>
<p>We recommend you only add <code>query</code> permissions for teams that should use the data source and only <code>Admin</code> have <code>Admin</code> permissions.</p>
<p>We recommend for a first setup, setting up as few rules as possible for each team and make them additive for simplicity.</p>
<p>To validate the rules, we recommend testing the rules in the Explore view. This will allow you to see the metrics or logs that would be returned for the rule.</p>
<h4 id="tasks">Tasks</h4>
<h3 id="task-1-one-rule-setup-for-each-team">Task 1: One rule setup for each team</h3>
<p>One common use case for creating an LBAC policy is to grant access to logs or metrics with a specific label. For example, you can create a label policy that includes all log lines or metrics with the label <code>namespace</code>.</p>
<p>We have two teams, Team A and Team B with <code>Query</code> permissions. Data source access is set up with <code>Admin</code> roles to have <code>Admin</code> permission only.</p>
<ul>
<li>
<p>Team A has a rule <code>namespace=&quot;dev&quot;</code>.</p>
</li>
<li>
<p>Team B has a rule <code>namespace=&quot;prod&quot;</code>.</p>
</li>
</ul>
<p>A user that is part of Team A will have access to logs or metrics matching <code>namespace=&quot;dev&quot;</code>. A user in both Team A and Team B will have access to data matching <code>namespace=&quot;dev&quot;</code> OR <code>namespace=&quot;prod&quot;</code>.</p>
<h3 id="task-2-set-up-a-rule-to-exclude-a-label-for-a-team">Task 2: Set up a rule to exclude a label for a team</h3>
<p>One common use case for creating an LBAC policy is to exclude logs or metrics that have a specific label. For example, you can create a label policy that excludes all log lines with the label <code>secret=true</code> by adding a selector with <code>secret!=&quot;true&quot;</code> when you create an access policy:</p>
<p>We have one team, Team A <code>Query</code> permissions. Data source access is setup with <code>Admin</code> roles to have <code>Admin</code> permission only.</p>
<ul>
<li>Team A has a rule <code>secret!=&quot;true&quot;</code>.</li>
</ul>
<p>A user that is part of Team A will <strong>NOT</strong> have access to logs or metrics that match <code>secret!=&quot;true&quot;</code>.</p>
<h3 id="task-3-set-up-multiple-rules-for-a-team">Task 3: Set up multiple rules for a team</h3>
<p>We have two teams, Team A and Team B with <code>Query</code> permissions. Data Source access is setup with <code>Admin</code> roles having <code>Admin</code> permission.</p>
<ul>
<li>
<p>Team A has rule <code>cluster=&quot;us-west-0&quot;, namespace=~&quot;dev|prod&quot;</code> configured.</p>
</li>
<li>
<p>Team B has rule <code>cluster=&quot;us-west-0&quot;, namespace=&quot;staging&quot;</code> configured.</p>
</li>
</ul>
<p>A user that is only part of Team A will have access to logs that match <code>cluster=&quot;us-west-0&quot; AND (namespace=&quot;dev&quot; OR namespace=&quot;prod&quot;)</code>.</p>
<p>A user that is only part of Team B will have access to logs that match <code>cluster=&quot;us-west-0&quot; AND namespace=&quot;staging&quot;</code>.</p>
<p>A user in Team A has access to logs in cluster us-west-0 with namespaces <code>dev</code> and <code>prod</code>. A user in Team B has access to to everything in cluster us-west-0, except namespace prod. So basically, user who is member of both team A and team B has access to everything in cluster us-west-0.</p>
<p>A user that is <strong>not</strong> part of any Team with <code>Editor/Viewer</code> role will not have access to query any logs.</p>
<p><strong>Important</strong></p>
<p>A <code>Admin</code> user that is part of a Team with will only have access to that teams logs</p>
<p>A <code>Admin</code> user that is not part of any Team with <code>Admin</code> role will have access to all logs</p>
<h3 id="task-4-rules-that-overlap">Task 4: Rules that overlap</h3>
<p>We have two teams, Team A and Team B.</p>
<ul>
<li>
<p>Team A has a rule <code>namespace=&quot;dev&quot;</code>.</p>
</li>
<li>
<p>Team B has a rule <code>namespace!=&quot;dev&quot;</code>.</p>
</li>
</ul>
<p>A user in Team A will have access to logs that match <code>namespace=&quot;dev&quot;</code>.</p>
<p>A user in Team B will have access to logs that match <code>namespace!=&quot;dev&quot;</code>.</p>
<blockquote>
<p><em>NOTE:</em> A user that is part of Team A and Team B will have access to all logs that match <code>namespace=&quot;dev&quot;</code> <code>OR</code> <code>namespace!=&quot;dev&quot;</code>.</p></blockquote>
<h3 id="task-5-single-rule-setup-for-a-team">Task 5: Single rule setup for a team</h3>
<p>We have two teams, Team A and Team B. Data Source access is setup with <code>Editor</code>, <code>Viewer</code> roles to have <code>Query</code> permission.</p>
<ul>
<li>
<p>Team A has a rule <code>namespace=&quot;dev&quot;</code> configured.</p>
</li>
<li>
<p>Team B does not have a rule configured for it.</p>
</li>
</ul>
<p>A user that is part of Team A will have access to logs that match <code>namespace=&quot;dev&quot;</code>.</p>
<p>A user that is part of Team A and part of Team B will have access to logs that match <code>namespace=&quot;dev&quot;</code>.</p>
<p>A user that is not part of Team A and part of Team B, that is <code>Editor</code> or <code>Viewer</code> will have access to all logs (due to the query permission for the user).</p>
<h3 id="task-6-user-a-is-admin-and-part-of-team-b">Task 6: User A is Admin and part of Team B</h3>
<p>We have team B, user A is part of Team B and has an <code>Admin</code> basic role.</p>
<ul>
<li>
<p>Team B has no roles assigned</p>
</li>
<li>
<p>Team B has Query permissions to data source</p>
</li>
<li>
<p>Team B has a rule <code>{ project_id=&quot;project-dev&quot; }</code></p>
</li>
</ul>
<p>User A may only access logs or metrics for a data source that match <code>{ project_id=&quot;project-dev&quot; }</code>.</p>
