<!DOCTYPE html>
<h1 id="activate-a-grafana-enterprise-license-from-aws-marketplace-on-eks">Activate a Grafana Enterprise license from AWS Marketplace on EKS</h1>
<p>If you have purchased a Grafana Enterprise subscription through AWS Marketplace, you must activate it to use Grafana Enterprise data source plugins and features in Grafana.</p>
<h2 id="before-you-begin">Before you begin:</h2>
<ul>
<li>Purchase a subscription to <a href="https://aws.amazon.com/marketplace/pp/prodview-dlncd4kzt5kx6" target="_blank" rel="noopener noreferrer">Grafana Enterprise from AWS Marketplace</a>.</li>
<li>Be sure that the IAM user that was used to purchase Grafana Enterprise has permission to manage subscriptions, create new IAM users and roles, and create access policies.</li>
</ul>
<p>To activate your license, complete the following tasks:</p>
<h2 id="task-1-deploy-grafana-enterprise-on-amazon-eks">Task 1: Deploy Grafana Enterprise on Amazon EKS</h2>
<ol>
<li>
<p>Deploy Grafana Enterprise on Amazon EKS.</p>
<p>For more information about deploying an application on Amazon EKS, refer to <a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html" target="_blank" rel="noopener noreferrer">Getting started with Amazon EKS â€“ AWS Management Console and AWS CLI</a>.</p>
<p>For more information about installing Grafana on Kubernetes using the Helm Chart, refer to the <a href="https://github.com/grafana/helm-charts/tree/main/charts/grafana#readme" target="_blank" rel="noopener noreferrer">Grafana Helm Chart</a>.</p>
</li>
<li>
<p>Use <code>kubectl set image deployment/my-release grafana=grafana/grafana-enterprise:&lt;version&gt;</code> to update the container image.</p>
<p>For example, enter <code>grafana/grafana-enterprise:11.3.0</code>.</p>
</li>
</ol>
<blockquote>
<p>Only Grafana Enterprise versions 8.3.0 and later support licenses granted through AWS Marketplace.</p></blockquote>
<h2 id="task-2-configure-grafana-for-high-availability">Task 2: Configure Grafana for high availability</h2>
<p>Grafana requires that you configure a database to hold dashboards, users, and other persistent data.</p>
<h3 id="before-you-begin-1">Before you begin</h3>
<ul>
<li>Ensure that you have a supported Grafana database available.
<ul>
<li>For a list of supported databases, refer to <a href="../../../../setup-grafana/installation/#supported-databases">Supported databases</a>.</li>
<li>For information about creating a database, refer to <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_CreateDBInstance.html" target="_blank" rel="noopener noreferrer">Creating an Amazon RDS DB instance</a>.</li>
</ul>
</li>
<li>Review the information required to connect to the RDS DB instance. For more information, refer to <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_CommonTasks.Connect.html" target="_blank" rel="noopener noreferrer">Connecting to an Amazon RDS DB instance</a>.</li>
</ul>
<p>To configure Grafana for high availability, choose <strong>one</strong> of the following options:</p>
<ul>
<li>
<p><strong>Option 1:</strong> Use <code>kubectl edit configmap grafana</code> to edit <code>grafana.ini</code> add the following section to the configuration:</p>
<pre>[database]
type = [database type]
host = [database address and port]
name = [database name]
user = [database username]
password = [database password]</pre>
</li>
<li>
<p><strong>Option 2:</strong> use <code>kubectl edit deployment my-release</code> to edit the pod <code>env</code> variables and add the following database variables:</p>
<pre>- name: GF_DATABASE_TYPE
  value: [database type]
- name: GF_DATABASE_HOST
  value: [database address and port]
- name: GF_DATABASE_NAME
  value: [database name]
- name: GF_DATABASE_USER
  value: [database username]
- name: GF_DATABASE_PASSWORD
  value: [database password]</pre>
</li>
</ul>
<p>For more information on Grafana High Availability setup, refer to <a href="../../../../setup-grafana/set-up-for-high-availability/">Set up Grafana for high availability</a>.</p>
<h2 id="task-3-configure-grafana-enterprise-to-validate-its-license-with-aws">Task 3: Configure Grafana Enterprise to validate its license with AWS</h2>
<p>In this task, you configure Grafana Enterprise to validate the license with AWS instead of Grafana Labs.</p>
<ol>
<li>
<p>In AWS IAM, assign the following permissions to the Node IAM role (if you are using a Node Group), or the Pod Execution role (if you are using a Fargate profile):</p>
<ul>
<li><code>&quot;license-manager:CheckoutLicense&quot;</code></li>
<li><code>&quot;license-manager:ListReceivedLicenses&quot;</code></li>
<li><code>&quot;license-manager:GetLicenseUsage&quot;</code></li>
<li><code>&quot;license-manager:CheckInLicense&quot;</code></li>
</ul>
<p>For more information about creating an access policy, refer to <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create-console.html" target="_blank" rel="noopener noreferrer">Creating IAM policies (console)</a>.</p>
<p>For more information about AWS license permissions, refer to <a href="https://docs.aws.amazon.com/service-authorization/latest/reference/list_awslicensemanager.html" target="_blank" rel="noopener noreferrer">Actions, resources, and condition keys for AWS License Manager</a>.</p>
</li>
<li>
<p>Choose <strong>one</strong> of the following options to update the <a href="../../../../setup-grafana/configure-grafana/enterprise-configuration/#license_validation_type">license_validation_type</a> configuration to <code>aws</code>:</p>
<ul>
<li>
<p><strong>Option 1:</strong> Use <code>kubectl edit configmap grafana</code> to edit <code>grafana.ini</code> add the following section to the configuration:</p>
<pre>[enterprise]
license_validation_type=aws</pre>
</li>
<li>
<p><strong>Option 2:</strong> Use <code>kubectl edit deployment my-release</code> to edit the pod <code>env</code> variables and add the following variable:</p>
<pre>name: GF_ENTERPRISE_LICENSE_VALIDATION_TYPE
value: aws</pre>
</li>
</ul>
</li>
</ol>
<h3 id="task-4-start-or-restart-grafana">Task 4: Start or restart Grafana</h3>
<p>To activate Grafana Enterprise features, you must start (or restart) Grafana.</p>
<p>To restart Grafana on a Kubernetes cluster,</p>
<ol>
<li>
<p>Run the command <code>kubectl rollout restart deployment my-release</code>.</p>
</li>
<li>
<p>After you update the service, navigate to your Grafana instance, sign in with Grafana Admin credentials, and navigate to <strong>Administration &gt; General &gt; Stats and license</strong> to validate that your license is active.</p>
</li>
</ol>
<p>For more information about restarting Grafana, refer to <a href="../../../../setup-grafana/start-restart-grafana/">Restart Grafana</a>.</p>
<blockquote>
<p>If you experience issues when you update the EKS cluster, refer to <a href="https://docs.aws.amazon.com/eks/latest/userguide/troubleshooting.html" target="_blank" rel="noopener noreferrer">Amazon EKS troubleshooting</a>.</p></blockquote>
