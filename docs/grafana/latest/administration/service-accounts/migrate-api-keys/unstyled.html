<!DOCTYPE html>
<h1 id="migrate-api-keys-to-service-account-tokens">Migrate API keys to service account tokens</h1>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>API keys are deprecated. 
    <a href="/docs/grafana/latest/administration/service-accounts/">Service accounts</a> now replace API keys for authenticating with the <strong>HTTP APIs</strong> and interacting with Grafana.</p></blockquote></div>

<p>API keys specify a role—either <strong>Admin</strong>, <strong>Editor</strong>, or <strong>Viewer</strong>—that determine the permissions associated with interacting with Grafana.</p>
<p>Compared to API keys, service accounts have limited scopes that provide more security. For more information on the benefits of service accounts, refer to 
    <a href="/docs/grafana/latest/administration/service-accounts/#service-account-benefits">service account benefits</a>.</p>
<p>When you migrate an API key to a service account, a service account is created with a service account token. Your existing API key—now migrated to a service account token—will continue working as before.</p>
<p>To find the migrated API keys, click <strong>Administration</strong> in the left-side menu, then <strong>Users and access -&gt; Service Accounts</strong>, select the service account, and locate the <strong>Token</strong>.</p>
<h2 id="migrate-api-keys-using-the-grafana-user-interface">Migrate API keys using the Grafana user interface</h2>
<p>This section shows you how to migrate API keys to Grafana service accounts using the Grafana user interface. You can choose to migrate a single API key or all API keys. When you migrate all API keys, you can no longer create API keys and must use service accounts instead.</p>
<h4 id="before-you-begin">Before you begin</h4>
<p>To follow these instructions, you need at least one of the following:</p>
<ul>
<li>Administrator permissions</li>
<li>Editor permissions</li>
<li>Service account writer</li>
</ul>
<p>For more information about permissions, refer to 
    <a href="/docs/grafana/latest/administration/roles-and-permissions/">Roles and permissions</a>.</p>
<h4 id="steps">Steps</h4>
<p>To migrate all API keys to service accounts, complete the following steps:</p>
<ol>
<li>Sign in to Grafana, point to <strong>Administration</strong>, <strong>Users and access</strong>, and click <strong>API Keys</strong>.</li>
<li>In the top of the page, find the section which says <strong>Switch from API keys to service accounts</strong></li>
<li>Click <strong>Migrate to service accounts now</strong>.</li>
<li>A confirmation window will appear, asking to confirm the migration. Click <strong>Yes, migrate now</strong> if you are willing to continue.</li>
<li>Once migration is successful, you can choose to forever hide the API keys page. Click <strong>Hide API keys page forever</strong> if you want to do that.</li>
</ol>
<p>To migrate a single API key to a service account, complete the following steps:</p>
<ol>
<li>Sign in to Grafana.</li>
<li>Click <strong>Administration</strong> in the left-side menu, <strong>Users and access</strong>, and select <strong>API Keys</strong>.</li>
<li>Find the API Key you want to migrate.</li>
<li>Click <strong>Migrate to service account</strong>.</li>
</ol>
<h2 id="migrate-api-keys-using-the-http-api">Migrate API keys using the HTTP API</h2>
<p>This section shows you how to programmatically migrate API keys to Grafana service accounts using the HTTP API. For API additional information, refer to 
    <a href="/docs/grafana/latest/developers/http_api/serviceaccount/">Service account HTTP APIs</a>.</p>
<h4 id="before-you-begin-1">Before you begin</h4>
<p>To follow these instructions, you need one of the following:</p>
<ul>
<li>Administrator permissions</li>
<li>Editor permissions</li>
<li>Service account writer</li>
</ul>
<h4 id="steps-1">Steps</h4>
<p>Complete the following steps to migrate from API keys to service accounts for API:</p>
<ol>
<li>
<p>Call the <code>POST /api/serviceaccounts</code> endpoint and the <code>POST /api/serviceaccounts/&lt;id&gt;/tokens</code>.</p>
<p>This action generates a service account token.</p>
</li>
<li>
<p>Store the ID and secret that the system returns to you.</p>
</li>
<li>
<p>Pass the token in the <code>Authorization</code> header, prefixed with <code>Bearer</code>.</p>
<p>This action authenticates API requests.</p>
</li>
<li>
<p>SATs used for authentication</p>
</li>
<li>
<p>Remove code that handles the old <code>/api/auth/keys</code> endpoint.</p>
</li>
<li>
<p>Track the <a href="http://localhost:3000/org/apikeys" target="_blank" rel="noopener noreferrer">API keys</a> in use and migrate them to SATs.</p>
</li>
</ol>
<h4 id="example">Example</h4>
<p>Your current setup</p>
<pre>curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{&#34;name&#34;: &#34;my-api-key&#34;, &#34;role&#34;: &#34;Viewer&#34;}&#39; http://admin:admin@localhost:3000/api/auth/keys

# response from the api
{&#34;id&#34;:2,&#34;name&#34;:&#34;my-api-key&#34;,&#34;key&#34;:&#34;eyJrIjoiTFRSN1RBOVc3SGhjblc0bWZodXZ3MnNDcU92Um5VZUIiLKJuIjoibXktYXBpLWtleSIsImlkIjoxfQ==&#34;}%</pre>
<p>New setup</p>
<pre># create a service account
curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{&#34;name&#34;: &#34;my-service-account&#34;, &#34;role&#34;: &#34;Viewer&#34;}&#39; http://admin:admin@localhost:3000/api/serviceaccounts

# response with the created service account id,name, login
{&#34;id&#34;:1,&#34;name&#34;:&#34;my-service-account&#34;,&#34;login&#34;:&#34;sa-my-service-account&#34;,&#34;orgId&#34;:1,&#34;isDisabled&#34;:false,&#34;role&#34;:&#34;Viewer&#34;,&#34;tokens&#34;:0,&#34;avatarUrl&#34;:&#34;&#34;}%

# create the service account token with the service account id 1 - /serviceaccounts/{id} returned from the previous step
curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{&#34;name&#34;: &#34;my-service-account-token&#34;}&#39; http://admin:admin@localhost:3000/api/serviceaccounts/1/tokens

# response with the created SAT id,name and key.
{&#34;id&#34;:2,&#34;name&#34;:&#34;my-service-account-token&#34;,&#34;key&#34;:&#34;glsa_9244xlVFZK0j8Lh4fU8Cz6Z5tO664zIi_7a762939&#34;}%

# now you can authenticate the same way as you did with the API key
curl --request GET --url http://localhost:3000/api/folders --header &#39;Authorization: Bearer glsa_9244xlVFZK0j8Lh4fU8Cz6Z5tO664zIi_7a762939&#39;

# response
[{&#34;id&#34;:1,&#34;uid&#34;:&#34;a5261a84-eebc-4733-83a9-61f4713561d1&#34;,&#34;title&#34;:&#34;gdev dashboards&#34;}]%</pre>
<h2 id="migrate-api-keys-using-terraform">Migrate API keys using Terraform</h2>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>The terraform resource <code>api_key</code> is removed from the Grafana Terraform Provider in v3.0.0.
Before you migrate and remove the use of the resource, you should pin your terraform version to a version less-than or equal-to v2.19.0.
For more information, refer to the <a href="https://github.com/grafana/terraform-provider-grafana/releases/tag/v3.0.0" target="_blank" rel="noopener noreferrer">Grafana Terraform Provider release notes</a>.</p></blockquote></div>

<p>To pin the Grafana Terraform Provider to v2.19.0:</p>
<pre>terraform {
  required_providers {
    grafana = {
      source  = &#34;grafana/grafana&#34;
      version = &#34;2.19.0&#34;
    }
  }
}</pre>
<p>This section shows you how to migrate your Terraform configuration for API keys to Grafana service accounts. For additional information, refer to <a href="https://registry.terraform.io/providers/grafana/grafana/latest/docs/resources/service_account_token" target="_blank" rel="noopener noreferrer">Grafana Service Accounts in Terraform</a>.</p>
<h4 id="steps-2">Steps</h4>
<p>Complete the following steps to migrate from API keys to service accounts using Terraform:</p>
<ol>
<li>Generate <code>grafana_service_account</code> and <code>grafana_service_account_token</code> resources.</li>
<li>Specify the desired scopes and expiration date when creating the service account.</li>
<li>Use the token returned from <code>grafana_service_account_token</code> to authenticate the API requests.</li>
<li>Remove the terraform configuration for creating your <code>grafana_api_key</code> resources.</li>
</ol>
<p><strong>Example: your current Terraform configuration</strong></p>
<pre>terraform {
  required_providers {
    grafana = {
      source  = &#34;grafana/grafana&#34;
    }
  }
}

# configure the provider with basic auth
provider &#34;grafana&#34; {
  url  = &#34;http://localhost:3000&#34;
  auth = &#34;admin:admin&#34;
}

resource &#34;grafana_api_key&#34; &#34;foo&#34; {
  name = &#34;key_foo&#34;
  role = &#34;Viewer&#34;
}

resource &#34;grafana_api_key&#34; &#34;bar&#34; {
  name            = &#34;key_bar&#34;
  role            = &#34;Admin&#34;
  seconds_to_live = 30
}</pre>
<p><strong>Your new Terraform configuration</strong></p>
<p><em>Note:</em> you can create multiple tokens using one service account.</p>
<pre>terraform {
  required_providers {
    grafana = {
      source  = &#34;grafana/grafana&#34;
    }
  }
}

# configure the provider with basic auth
provider &#34;grafana&#34; {
  url  = &#34;http://localhost:3000&#34;
  auth = &#34;admin:admin&#34;
}

# Creating a service account in Grafana instance to be used as auth and attach tokens
# notice we can attach multiple tokens to one service account
resource &#34;grafana_service_account&#34; &#34;sa-admin&#34; {
  name             = &#34;sa-admin&#34;
  role             = &#34;Admin&#34;
}

# Creating a service account token in Grafana instance to be used for creating resources in Grafana instance
resource &#34;grafana_service_account_token&#34; &#34;sat-bar&#34; {
  name           = &#34;sat-bar&#34;
  service_account_id = grafana_service_account.sa-admin.id
}

# Creating a service account token in Grafana instance to be used for creating resources in Grafana instance
resource &#34;grafana_service_account_token&#34; &#34;sat-foo&#34; {
  name           = &#34;sat-foo&#34;
  service_account_id = grafana_service_account.sa-admin.id
  seconds_to_live    = 30
}</pre>
<h2 id="migrate-cloud-stack-api-keys-using-terraform">Migrate Cloud Stack API keys using Terraform</h2>
<p>This section shows you how to migrate your Terraform configuration for Grafana cloud stack API keys to Grafana cloud stack service accounts.</p>
<p>For migration your cloud stack api keys, use the <code>grafana_cloud_stack_service_account</code> and <code>gafana_cloud_stack_service_account_token</code> resources. For additional information, refer to <a href="https://registry.terraform.io/providers/grafana/grafana/latest/docs/resources/cloud_stack_service_account" target="_blank" rel="noopener noreferrer">Grafana Cloud Stack Service Accounts in Terraform</a>.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>This is only relevant for Grafana Cloud <strong>Stack</strong> API keys <code>grafana_cloud_stack_api_key</code>. Grafana Cloud API keys resource <code>grafana_cloud_api_key</code> are not deprecated and should be used for authentication for managing your Grafana cloud.</p></blockquote></div>

<h4 id="steps-3">Steps</h4>
<p>Complete the following steps to migrate from cloud stack API keys to cloud stack service accounts using Terraform:</p>
<ol>
<li>Generate <code>grafana_cloud_stack_service_account</code> and <code>grafana_cloud_stack_service_account_token</code> resources.</li>
<li>Specify the desired scopes and expiration date when creating the service account.</li>
<li>Use the token returned from <code>grafana_cloud_stack_service_account_token</code> to authenticate the API requests.</li>
<li>Remove the Terraform configuration for creating your <code>grafana_cloud_stack_api_key</code> resources.</li>
</ol>
<p><strong>Example: Your current Terraform configuration</strong></p>
<pre>terraform {
  required_providers {
    grafana = {
      source = &#34;grafana/grafana&#34;
    }
  }
}

# Declaring the first provider to be only used for creating the cloud-stack
provider &#34;grafana&#34; {
  alias = &#34;cloud&#34;

  cloud_api_key = &#34;&lt;API-Key&gt;&#34;
}

resource &#34;grafana_cloud_stack&#34; &#34;my_stack&#34; {
  provider = grafana.cloud

  name        = &#34;my_stack&#34;
  slug        = &#34;my_stack&#34;
  region_slug = &#34;eu&#34; # Example “us”,”eu” etc
}

# Creating a Grafana API key to be used as auth
resource &#34;grafana_cloud_stack_api_key&#34; &#34;management&#34; {
  provider = grafana.cloud

  stack_slug = grafana_cloud_stack.my_stack.slug
  name       = &#34;management-key&#34;
  role       = &#34;Admin&#34;
}</pre>
<p><strong>Your new Terraform configuration</strong></p>
<pre>terraform {
  required_providers {
    grafana = {
      source = &#34;grafana/grafana&#34;
    }
  }
}

# Declaring the first provider to be only used for creating the cloud-stack
provider &#34;grafana&#34; {
  alias = &#34;cloud&#34;

  cloud_api_key = &#34;&lt;API-Key&gt;&#34;
}

resource &#34;grafana_cloud_stack&#34; &#34;my_stack&#34; {
  provider = grafana.cloud

  name        = &#34;my_stack&#34;
  slug        = &#34;my_stack&#34;
  region_slug = &#34;eu&#34; # Example “us”,”eu” etc
}

# Creating a grafana cloud stack service account
resource &#34;grafana_cloud_stack_service_account&#34; &#34;mystack_cloud-stack_service_account&#34; {
  provider   = grafana.cloud
  stack_slug = grafana_cloud_stack.my_stack.slug

  name = &#34;mystack-cloud-stack-sa&#34;
  role = &#34;Admin&#34;
}

# Creating a grafana cloud stack service account token
resource &#34;grafana_cloud_stack_service_account_token&#34; &#34;mystack_cloud-stack_service-account_token&#34; {
  provider   = grafana.cloud
  stack_slug = grafana_cloud_stack.my_stack.slug

  name               = &#34;mystack-cloud-stack-sa-token&#34;
  service_account_id = grafana_cloud_stack_service_account.mystack_cloud-stack_service_account.id
}</pre>
