<!DOCTYPE html>
<h1 id="multiple-providers-with-keycloak-in-grafana">Multiple providers with Keycloak in Grafana</h1>
<p>While Grafana offers a variety of authentication providers, you can only configure one provider of one type at a time. However, you can configure multiple providers of the same type with the help of Keycloak.</p>
<p>This guide explains how to set up multiple providers of the same type with Keycloak as an authentication provider in Grafana.</p>
<p>The idea is to set up multiple OIDC providers in Keycloak with different tenants and configure Grafana to use the same Keycloak instance as the authentication provider.</p>
<h2 id="azure-ad-configuration">Azure AD configuration</h2>
<p>For Azure AD, repeat the following steps for each tenant you want to set up in Keycloak.</p>
<h3 id="overview">Overview</h3>
<ol>
<li>Register your application in Azure AD.</li>
<li>Give access to the application to the users in the tenant.</li>
<li>Create credentials for the application.</li>
<li>Configure the application in Keycloak.</li>
<li>Configure Grafana to use Keycloak.</li>
</ol>
<h4 id="register-your-application-in-azure-ad">Register your application in Azure AD</h4>
<p>Registering an application in Azure AD is a one-time process. You can follow the steps in the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app" target="_blank" rel="noopener noreferrer">Azure AD documentation</a> to register your application.</p>
<ol>
<li>Go to the Azure portal and ensure you are using the correct tenant also known as directory.</li>
<li>Search for <strong>App Registrations</strong> and click on <strong>New registration</strong>.</li>
<li>Fill in the details for the application and click <strong>Register</strong>. You&rsquo;ll be redirected to the application&rsquo;s overview page.</li>
</ol>
<h4 id="give-access-to-the-application-to-the-users-in-the-tenant">Give access to the application to the users in the tenant</h4>
<p>Assigning the correct access to users ensures only intended users or groups have access to the application.</p>
<ol>
<li>Search for <strong>Enterprise Applications</strong> and look for the application you just created in the previous step.</li>
<li>Under the <strong>Manage</strong> section, click on <strong>Users and groups</strong>.</li>
<li>Click on <strong>Add user/group</strong> and add the users or groups that should have access to the application.</li>
</ol>
<h4 id="create-credentials-for-the-application">Create credentials for the application</h4>
<p>To authenticate with Azure AD, the Keycloak application needs a client ID and client secret.</p>
<ol>
<li>Search for <strong>App Registrations</strong> and look for the application ypu just created.</li>
<li>Click on <strong>Certificates &amp; Secrets</strong>.</li>
<li>Click on <strong>New client secret</strong> and fill in the details. Make sure to copy the secret value as it will not be shown again.</li>
</ol>
<h4 id="configure-the-application-in-keycloak">Configure the application in Keycloak</h4>
<ol>
<li>Go to the Keycloak admin console.</li>
<li>Go to the Realm where you want to configure the Azure AD tenant.</li>
<li>Go to the Identity Providers section and click on <strong>Add provider</strong>.</li>
<li>Select <strong>OpenID Connect v1.0</strong>.
<ol>
<li>Select a unique <strong>Alias</strong> and <strong>Display name</strong>.</li>
<li>Copy the <strong>Redirect URI</strong>.</li>
<li>Back in Azure Portal, go to the application&rsquo;s <strong>Authentication</strong> section.</li>
<li>Add a <strong>new platform</strong> and select <strong>Web</strong>.</li>
<li>Paste the <strong>Redirect URI</strong> from Keycloak.</li>
<li>Save the changes.</li>
<li>Navigate to the Azure Application overview and look for the <strong>Endpoints</strong> tab.</li>
<li>Copy the <strong>OpenID Connect metadata document</strong> URL.</li>
<li>Head back to Keycloak and paste the URL in the <strong>Discovery endpoint</strong> field.</li>
<li>Navigate to the Azure application overview and look for the <strong>Application (client) ID</strong>.</li>
<li>Copy the <strong>Application ID</strong> and paste it in the <strong>Client ID</strong> field in Keycloak.</li>
<li>Paste the client secret you created in the previous step in the <strong>Client secret</strong> field.</li>
<li>Click Add.</li>
</ol>
</li>
</ol>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Up to this point, you have created an App Registration in Azure AD, assigned users to the application, created credentials for the application, and configured the application in Keycloak. In the Keycloak Client&rsquo;s section, the client with ID <code>account</code> Home URL can be used to test the configuration. This will open a new tab where you can login into the correct Keycloak realm with the Azure AD tenant you just configured.</p></blockquote></div>

<p>Repeat this steps, for every Azure AD tenant you want to configure in Keycloak.</p>
<h4 id="configure-grafana-to-use-keycloak">Configure Grafana to use Keycloak</h4>
<p>Now that the Azure AD tenants are configured in Keycloak, you can configure Grafana to use Keycloak as the authentication provider.</p>
<p>Refer to the <a href="/docs/grafana/latest/auth/keycloak/">Keycloak documentation</a> to configure Grafana to use Keycloak as the authentication provider.</p>
