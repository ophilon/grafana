<!DOCTYPE html>
<h1 id="configure-database-encryption">Configure database encryption</h1>
<p>Grafana’s database contains secrets, which are used to query data sources, send alert notifications, and perform other functions within Grafana.</p>
<p>Grafana encrypts these secrets before they are written to the database, by using a symmetric-key encryption algorithm called Advanced Encryption Standard (AES). These secrets are signed using a <a href="../../configure-grafana/#secret_key">secret key</a> that you can change when you configure a new Grafana instance.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Grafana v9.0 and newer use <a href="#envelope-encryption">envelope encryption</a> by default, which adds a layer of indirection to the encryption process that introduces an <a href="#implicit-breaking-change"><strong>implicit breaking change</strong></a> for older versions of Grafana.</p></blockquote></div>

<p>For further details about how to operate a Grafana instance with envelope encryption, see the <a href="#operational-work">Operational work</a> section.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>In Grafana Enterprise, you can also <a href="#changing-your-encryption-mode-to-aes-gcm">encrypt secrets in AES-GCM (Galois/Counter Mode)</a> instead of the default AES-CFB (Cipher FeedBack mode).</p></blockquote></div>

<h2 id="envelope-encryption">Envelope encryption</h2>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Since Grafana v9.0, you can turn envelope encryption off by adding the feature toggle <code>disableEnvelopeEncryption</code> to your <a href="../../configure-grafana/#feature_toggles">Grafana configuration</a>.</p></blockquote></div>

<p>Instead of encrypting all secrets with a single key, Grafana uses a set of keys called data encryption keys (DEKs) to encrypt them. These data encryption keys are themselves encrypted with a single key encryption key (KEK), configured through the <code>secret_key</code> attribute in your
<a href="../../configure-grafana/#secret_key">Grafana configuration</a> or by <a href="#encrypting-your-database-with-a-key-from-a-key-management-service-kms">Encrypting your database with a key from a key management service (KMS)</a>.</p>
<h3 id="implicit-breaking-change">Implicit breaking change</h3>
<p>Envelope encryption introduces an implicit breaking change to versions of Grafana prior to v9.0, because it changes how secrets stored in the Grafana database are encrypted. Grafana administrators can upgrade to Grafana v9.0 with no action required from the database encryption perspective, but must be extremely careful if they need to roll an upgrade back to Grafana v8.5 or earlier because secrets created or modified after upgrading to Grafana v9.0 can’t be decrypted by previous versions.</p>
<p>Grafana v8.5 implemented envelope encryption behind an optional feature toggle. Grafana administrators who need to downgrade to Grafana v8.5 can enable envelope encryption as a workaround by adding the feature toggle <code>envelopeEncryption</code> to the <a href="../../configure-grafana/#feature_toggles">Grafana configuration</a>.</p>
<h2 id="operational-work">Operational work</h2>
<p>From the database encryption perspective, Grafana administrators can:</p>
<ul>
<li><a href="#re-encrypt-secrets"><strong>Re-encrypt secrets</strong></a>: re-encrypt secrets with envelope encryption and a fresh data key.</li>
<li><a href="#roll-back-secrets"><strong>Roll back secrets</strong></a>: decrypt secrets encrypted with envelope encryption and re-encrypt them with legacy encryption.</li>
<li><a href="#re-encrypt-data-keys"><strong>Re-encrypt data keys</strong></a>: re-encrypt data keys with a fresh key encryption key and a KMS integration.</li>
<li><a href="#rotate-data-keys"><strong>Rotate data keys</strong></a>: disable active data keys and stop using them for encryption in favor of a fresh one.</li>
</ul>
<h3 id="re-encrypt-secrets">Re-encrypt secrets</h3>
<p>You can re-encrypt secrets in order to:</p>
<ul>
<li>Move already existing secrets&rsquo; encryption forward from legacy to envelope encryption.</li>
<li>Re-encrypt secrets after a <a href="#rotate-data-keys">data keys rotation</a>.</li>
</ul>
<p>To re-encrypt secrets, use the <a href="../../../cli/">Grafana CLI</a> by running the <code>grafana cli admin secrets-migration re-encrypt</code> command or the <code>/encryption/reencrypt-secrets</code> endpoint of the Grafana <a href="../../../developers/http_api/admin/#roll-back-secrets">Admin API</a>. It&rsquo;s safe to run more than once, more recommended under maintenance mode.</p>
<h3 id="roll-back-secrets">Roll back secrets</h3>
<p>You can roll back secrets encrypted with envelope encryption to legacy encryption. This might be necessary to downgrade to Grafana versions prior to v9.0 after an unsuccessful upgrade.</p>
<p>To roll back secrets, use the <a href="../../../cli/">Grafana CLI</a> by running the <code>grafana cli admin secrets-migration rollback</code> command or the <code>/encryption/rollback-secrets</code> endpoint of the Grafana <a href="../../../developers/http_api/admin/#re-encrypt-secrets">Admin API</a>. It&rsquo;s safe to run more than once, more recommended under maintenance mode.</p>
<h3 id="re-encrypt-data-keys">Re-encrypt data keys</h3>
<p>You can re-encrypt data keys encrypted with a specific key encryption key (KEK). This allows you to either re-encrypt existing data keys with a new KEK version or to re-encrypt them with a completely different KEK.</p>
<p>To re-encrypt data keys, use the <a href="../../../cli/">Grafana CLI</a> by running the <code>grafana cli admin secrets-migration re-encrypt-data-keys</code> command or the <code>/encryption/reencrypt-data-keys</code> endpoint of the Grafana <a href="../../../developers/http_api/admin/#re-encrypt-data-encryption-keys">Admin API</a>. It&rsquo;s safe to run more than once, more recommended under maintenance mode.</p>
<h3 id="rotate-data-keys">Rotate data keys</h3>
<p>You can rotate data keys to disable the active data key and therefore stop using them for encryption operations. For high-availability setups, you might need to wait until the data keys cache&rsquo;s time-to-live (TTL) expires to ensure that all rotated data keys are no longer being used for encryption operations.</p>
<p>New data keys for encryption operations are generated on demand.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Data key rotation does <strong>not</strong> implicitly re-encrypt secrets. Grafana will continue to use rotated data keys to decrypt
secrets still encrypted with them. To completely stop using
rotated data keys for both encryption and decryption, see <a href="#re-encrypt-secrets">secrets re-encryption</a>.</p></blockquote></div>

<p>To rotate data keys, use the <code>/encryption/rotate-data-keys</code> endpoint of the Grafana <a href="../../../developers/http_api/admin/#rotate-data-encryption-keys">Admin API</a>. It&rsquo;s safe to call more than once, more recommended under maintenance mode.</p>
<h2 id="encrypting-your-database-with-a-key-from-a-key-management-service-kms">Encrypting your database with a key from a key management service (KMS)</h2>
<p>If you are using Grafana Enterprise, you can integrate with a key management service (KMS) provider, and change Grafana’s cryptographic mode of operation from AES-CFB to AES-GCM.</p>
<p>You can choose to encrypt secrets stored in the Grafana database using a key from a KMS, which is a secure central storage location that is designed to help you to create and manage cryptographic keys and control their use across many services. When you integrate with a KMS, Grafana does not directly store your encryption key. Instead, Grafana stores KMS credentials and the identifier of the key, which Grafana uses to encrypt the database.</p>
<p>Grafana integrates with the following key management services:</p>
<ul>
<li><a href="encrypt-secrets-using-aws-kms/">AWS KMS</a></li>
<li><a href="encrypt-secrets-using-azure-key-vault/">Azure Key Vault</a></li>
<li><a href="encrypt-secrets-using-google-cloud-kms/">Google Cloud KMS</a></li>
<li><a href="encrypt-secrets-using-hashicorp-key-vault/">Hashicorp Key Vault</a></li>
</ul>
<h2 id="changing-your-encryption-mode-to-aes-gcm">Changing your encryption mode to AES-GCM</h2>
<p>Grafana encrypts secrets using Advanced Encryption Standard in Cipher FeedBack mode (AES-CFB). You might prefer to use AES in Galois/Counter Mode (AES-GCM) instead, to meet your company’s security requirements or in order to maintain consistency with other services.</p>
<p>To change your encryption mode, update the <code>algorithm</code> value in the <code>[security.encryption]</code> section of your Grafana configuration file. For further details, refer to <a href="../../configure-grafana/enterprise-configuration/#securityencryption">Enterprise configuration</a>.</p>
