<!DOCTYPE html>
<h1 id="deploy-grafana-on-kubernetes">Deploy Grafana on Kubernetes</h1>
<p>On this page, you will find instructions for installing and running Grafana on Kubernetes using Kubernetes manifests for the setup. If Helm is your preferred option, refer to <a href="https://github.com/grafana/helm-charts" target="_blank" rel="noopener noreferrer">Grafana Helm community charts</a>.</p>
<p>Watch this video to learn more about installing Grafana on Kubernetes: <iframe width="560" height="315" src="https://www.youtube.com/embed/cqHO0oYW6Ic?si=DEv5wtZxNCk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></p>
<h2 id="before-you-begin">Before you begin</h2>
<p>To follow this guide:</p>
<ul>
<li>
<p>You need the latest version of <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a> running either locally or remotely on a public or private cloud.</p>
</li>
<li>
<p>If you plan to use it in a local environment, you can use various Kubernetes options such as <a href="https://minikube.sigs.k8s.io/docs/" target="_blank" rel="noopener noreferrer">minikube</a>, <a href="https://kind.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">kind</a>, <a href="https://docs.docker.com/desktop/kubernetes/" target="_blank" rel="noopener noreferrer">Docker Desktop</a>, and others.</p>
</li>
<li>
<p>If you plan to use Kubernetes in a production setting, it&rsquo;s recommended to utilize managed cloud services like <a href="https://cloud.google.com/kubernetes-engine" target="_blank" rel="noopener noreferrer">Google Kubernetes Engine (GKE)</a>, <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Service (EKS)</a>, or <a href="https://azure.microsoft.com/en-us/products/kubernetes-service/" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS)</a>.</p>
</li>
</ul>
<h2 id="system-requirements">System requirements</h2>
<p>This section provides minimum hardware and software requirements.</p>
<h3 id="minimum-hardware-requirements">Minimum Hardware Requirements</h3>
<ul>
<li>Disk space: 1 GB</li>
<li>Memory: 750 MiB (approx 750 MB)</li>
<li>CPU: 250m (approx 0.25 cores)</li>
</ul>
<h3 id="supported-databases">Supported databases</h3>
<p>For a list of supported databases, refer to <a href="/docs/grafana/latest/setup-grafana/installation/#supported-databases">supported databases</a>.</p>
<h3 id="supported-web-browsers">Supported web browsers</h3>
<p>For a list of support web browsers, refer to <a href="/docs/grafana/latest/setup-grafana/installation/#supported-web-browsers">supported web browsers</a>.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Enable port <code>3000</code> in your network environment, as this is the Grafana default port.</p></blockquote></div>

<h2 id="deploy-grafana-oss-on-kubernetes">Deploy Grafana OSS on Kubernetes</h2>
<p>This section explains how to install Grafana OSS using Kubernetes.


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>If you want to install Grafana Enterprise on Kubernetes, refer to <a href="#deploy-grafana-enterprise-on-kubernetes">Deploy Grafana Enterprise on Kubernetes</a>.</p></blockquote></div>
</p>
<p>If you deploy an application in Kubernetes, it will use the default namespace which may already have other applications running. This can result in conflicts and other issues.</p>
<p>It is recommended to create a new namespace in Kubernetes to better manage, organize, allocate, and manage cluster resources. For more information about Namespaces, refer to the official <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">Kubernetes documentation</a>.</p>
<ol>
<li>
<p>To create a namespace, run the following command:</p>
<pre>kubectl create namespace my-grafana</pre>
<p>In this example, the namespace is <code>my-grafana</code></p>
</li>
<li>
<p>To verify and view the newly created namespace, run the following command:</p>
<pre>kubectl get namespace my-grafana</pre>
<p>The output of the command provides more information about the newly created namespace.</p>
</li>
<li>
<p>Create a YAML manifest file named <code>grafana.yaml</code>. This file will contain the necessary code for deployment.</p>
<pre>touch grafana.yaml</pre>
<p>In the next step you define the following three objects in the YAML file.</p>
<table>
  <thead>
      <tr>
          <th>Object</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Persistent Volume Claim (PVC)</td>
          <td>This object stores the data.</td>
      </tr>
      <tr>
          <td>Service</td>
          <td>This object provides network access to the Pod defined in the deployment.</td>
      </tr>
      <tr>
          <td>Deployment</td>
          <td>This object is responsible for creating the pods, ensuring they stay up to date, and managing Replicaset and Rolling updates.</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>Copy and paste the following contents and save it in the <code>grafana.yaml</code> file.</p>
<pre>---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: grafana
  name: grafana
spec:
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472
        supplementalGroups:
          - 0
      containers:
        - name: grafana
          image: grafana/grafana:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
              name: http-grafana
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /robots.txt
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 2
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 3000
            timeoutSeconds: 1
          resources:
            requests:
              cpu: 250m
              memory: 750Mi
          volumeMounts:
            - mountPath: /var/lib/grafana
              name: grafana-pv
      volumes:
        - name: grafana-pv
          persistentVolumeClaim:
            claimName: grafana-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  ports:
    - port: 3000
      protocol: TCP
      targetPort: http-grafana
  selector:
    app: grafana
  sessionAffinity: None
  type: LoadBalancer</pre>
</li>
<li>
<p>Run the following command to send the manifest to the Kubernetes API server:</p>
<pre>kubectl apply -f grafana.yaml --namespace=my-grafana</pre>
<p>This command creates the PVC, Deployment, and Service objects.</p>
</li>
<li>
<p>Complete the following steps to verify the deployment status of each object.</p>
<p>a. For PVC, run the following command:</p>
<pre>kubectl get pvc --namespace=my-grafana -o wide</pre>
<p>b. For Deployment, run the following command:</p>
<pre>kubectl get deployments --namespace=my-grafana -o wide</pre>
<p>c. For Service, run the following command:</p>
<pre>kubectl get svc --namespace=my-grafana -o wide</pre>
</li>
</ol>
<h2 id="access-grafana-on-managed-k8s-providers">Access Grafana on Managed K8s Providers</h2>
<p>In this task, you access Grafana deployed on a Managed Kubernetes provider using a web browser. Accessing Grafana via a web browser is straightforward if it is deployed on a Managed Kubernetes Provider as it uses the cloud provider’s <strong>LoadBalancer</strong> to which the external load balancer routes are automatically created.</p>
<ol>
<li>
<p>Run the following command to obtain the deployment information:</p>
<pre>kubectl get all --namespace=my-grafana</pre>
<p>The output returned should look similar to the following:</p>
<pre>NAME                           READY   STATUS    RESTARTS   AGE
pod/grafana-69946c9bd6-kwjb6   1/1     Running   0          7m27s

NAME              TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)          AGE
service/grafana   LoadBalancer   10.5.243.226   1.120.130.330   3000:31171/TCP   7m27s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/grafana   1/1     1            1           7m29s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/grafana-69946c9bd6   1         1         1       7m30s</pre>
</li>
<li>
<p>Identify the <strong>EXTERNAL-IP</strong> value in the output and type it into your browser.</p>
<p>The Grafana sign-in page appears.</p>
</li>
<li>
<p>To sign in, enter <code>admin</code> for both the username and password.</p>
</li>
<li>
<p>If you do not see the EXTERNAL-IP, complete the following steps:</p>
<p>a. Run the following command to do a port-forwarding of the Grafana service on port <code>3000</code>.</p>
<pre>kubectl port-forward service/grafana 3000:3000 --namespace=my-grafana</pre>
<p>For more information about port-forwarding, refer to <a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/" target="_blank" rel="noopener noreferrer">Use Port Forwarding to Access Applications in a Cluster</a>.</p>
<p>b. Navigate to <code>localhost:3000</code> in your browser.</p>
<p>The Grafana sign-in page appears.</p>
<p>c. To sign in, enter <code>admin</code> for both the username and password.</p>
</li>
</ol>
<h2 id="access-grafana-using-minikube">Access Grafana using minikube</h2>
<p>There are multiple ways to access the Grafana UI on a web browser when using minikube. For more information about minikube, refer to <a href="https://minikube.sigs.k8s.io/docs/handbook/accessing/" target="_blank" rel="noopener noreferrer">How to access applications running within minikube</a>.</p>
<p>This section lists the two most common options for accessing an application running in minikube.</p>
<h3 id="option-1-expose-the-service">Option 1: Expose the service</h3>
<p>This option uses the <code>type: LoadBalancer</code> in the <code>grafana.yaml</code> service manifest, which makes the service accessible through the <code>minikube service</code> command. For more information, refer to <a href="https://minikube.sigs.k8s.io/docs/commands/service/" target="_blank" rel="noopener noreferrer">minikube Service command usage</a>.</p>
<ol>
<li>
<p>Run the following command to obtain the Grafana service IP:</p>
<pre>minikube service grafana --namespace=my-grafana</pre>
<p>The output returns the Kubernetes URL for service in your local cluster.</p>
<pre>|------------|---------|-------------|------------------------------|
| NAMESPACE  |  NAME   | TARGET PORT |             URL              |
|------------|---------|-------------|------------------------------|
| my-grafana | grafana |        3000 | http://192.168.122.144:32182 |
|------------|---------|-------------|------------------------------|
Opening service my-grafana/grafana in default browser...
http://192.168.122.144:32182</pre>
</li>
<li>
<p>Run a <code>curl</code> command to verify whether a given connection should work in a browser under ideal circumstances.</p>
<pre>curl 192.168.122.144:32182</pre>
<p>The following example output shows that an endpoint has been located:</p>
<p><code>&lt;a href=&quot;/login&quot;&gt;Found&lt;/a&gt;.</code></p>
</li>
<li>
<p>Access the Grafana UI in the browser using the provided IP:Port from the command above. For example <code>192.168.122.144:32182</code></p>
<p>The Grafana sign-in page appears.</p>
</li>
<li>
<p>To sign in to Grafana, enter <code>admin</code> for both the username and password.</p>
</li>
</ol>
<h3 id="option-2-use-port-forwarding">Option 2: Use port forwarding</h3>
<p>If Option 1 does not work in your minikube environment (this mostly depends on the network), then as an alternative you can use the port forwarding option for the Grafana service on port <code>3000</code>.</p>
<p>For more information about port forwarding, refer to <a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/" target="_blank" rel="noopener noreferrer">Use Port Forwarding to Access Applications in a Cluster</a>.</p>
<ol>
<li>
<p>To find the minikube IP address, run the following command:</p>
<pre>minikube ip</pre>
<p>The output contains the IP address that you use to access the Grafana Pod during port forwarding.</p>
<p>A Pod is the smallest deployment unit in Kubernetes and is the core building block for running applications in a Kubernetes cluster. For more information about Pods, refer to <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Pods</a>.</p>
</li>
<li>
<p>To obtain the Grafana Pod information, run the following command:</p>
<pre>kubectl get pods --namespace=my-grafana</pre>
<p>The output should look similar to the following:</p>
<pre>NAME                       READY   STATUS    RESTARTS   AGE
grafana-58445b6986-dxrrw   1/1     Running   0          9m54s</pre>
<p>The output shows the Grafana POD name in the <code>NAME</code> column, that you use for port forwarding.</p>
</li>
<li>
<p>Run the following command for enabling the port forwarding on the POD:</p>
<pre>kubectl port-forward pod/grafana-58445b6986-dxrrw --namespace=my-grafana --address 0.0.0.0 3000:3000</pre>
</li>
<li>
<p>To access the Grafana UI on the web browser, type the minikube IP along with the forwarded port. For example <code>192.168.122.144:3000</code></p>
<p>The Grafana sign-in page appears.</p>
</li>
<li>
<p>To sign in to Grafana, enter <code>admin</code> for both the username and password.</p>
</li>
</ol>
<h2 id="update-an-existing-deployment-using-a-rolling-update-strategy">Update an existing deployment using a rolling update strategy</h2>
<p>Rolling updates enable deployment updates to take place with no downtime by incrementally updating Pods instances with new ones. The new Pods will be scheduled on nodes with available resources. For more information about rolling updates, refer to <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/" target="_blank" rel="noopener noreferrer">Performing a Rolling Update</a>.</p>
<p>The following steps use the <code>kubectl annotate</code> command to add the metadata and keep track of the deployment. For more information about <code>kubectl annotate</code>, refer to <a href="https://jamesdefabia.github.io/docs/user-guide/kubectl/kubectl_annotate/" target="_blank" rel="noopener noreferrer">kubectl annotate documentation</a>.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Instead of using the <code>annotate</code> flag, you can still use the <code>--record</code> flag. However, it has been deprecated and will be removed in the future version of Kubernetes. See: <a href="https://github.com/kubernetes/kubernetes/issues/40422" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/issues/40422</a></p></blockquote></div>

<ol>
<li>
<p>To view the current status of the rollout, run the following command:</p>
<pre>kubectl rollout history deployment/grafana --namespace=my-grafana</pre>
<p>The output will look similar to this:</p>
<pre>deployment.apps/grafana
REVISION  CHANGE-CAUSE
1         NONE</pre>
<p>The output shows that nothing has been updated or changed after applying the <code>grafana.yaml</code> file.</p>
</li>
<li>
<p>To add metadata to keep record of the initial deployment, run the following command:</p>
<pre>kubectl annotate deployment/grafana kubernetes.io/change-cause=&#39;deployed the default base yaml file&#39; --namespace=my-grafana</pre>
</li>
<li>
<p>To review the rollout history and verify the changes, run the following command:</p>
<pre>kubectl rollout history deployment/grafana --namespace=my-grafana</pre>
<p>You should see the updated information that you added in the <code>CHANGE-CAUSE</code> earlier.</p>
</li>
</ol>
<h3 id="change-grafana-image-version">Change Grafana image version</h3>
<ol>
<li>
<p>To change the deployed Grafana version, run the following <code>kubectl edit</code> command:</p>
<pre>kubectl edit deployment grafana --namespace=my-grafana</pre>
</li>
<li>
<p>In the editor, change the container image under the <code>kind: Deployment</code> section.</p>
<p>For example:</p>
<ul>
<li>
<p>From</p>
<ul>
<li><code>yaml image: grafana/grafana:12.1.0</code></li>
</ul>
</li>
<li>
<p>To</p>
<ul>
<li><code>yaml image: grafana/grafana-dev:12.2.0-17161637292</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Save the changes.</p>
<p>Once you save the file, you receive a message similar to the following:</p>
<pre>deployment.apps/grafana edited</pre>
<p>This means that the changes have been applied.</p>
</li>
<li>
<p>To verify that the rollout on the cluster is successful, run the following command:</p>
<pre>kubectl rollout status deployment grafana --namespace=my-grafana</pre>
<p>A successful deployment rollout means that the Grafana Dev cluster is now available.</p>
</li>
<li>
<p>To check the statuses of all deployed objects, run the following command and include the <code>-o wide</code> flag to get more detailed output:</p>
<pre>kubectl get all --namespace=my-grafana -o wide</pre>
<p>You should see the newly deployed <code>grafana-dev</code> image.</p>
</li>
<li>
<p>To verify it, access the Grafana UI in the browser using the provided IP:Port from the command above.</p>
<p>The Grafana sign-in page appears.</p>
</li>
<li>
<p>To sign in to Grafana, enter <code>admin</code> for both the username and password.</p>
</li>
<li>
<p>In the top-right corner, click the help icon.</p>
<p>The version information appears.</p>
</li>
<li>
<p>Add the <code>change cause</code> metadata to keep track of things using the commands:</p>
<pre>kubectl annotate deployment grafana --namespace=my-grafana kubernetes.io/change-cause=&#39;using grafana-dev:12.2.0-17161637292 for testing&#39;</pre>
</li>
<li>
<p>To verify, run the <code>kubectl rollout history</code> command:</p>
<pre>kubectl rollout history deployment grafana --namespace=my-grafana</pre>
<p>You will see an output similar to this:</p>
<pre>deployment.apps/grafana
REVISION  CHANGE-CAUSE
1         deploying the default yaml
2         using grafana-dev:12.2.0-17161637292 for testing</pre>
</li>
</ol>
<p>This means that <code>REVISION#2</code> is the current version.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>The last line of the <code>kubectl rollout history deployment</code> command output is the one which is currently active and running on your Kubernetes environment.</p></blockquote></div>

<h3 id="roll-back-a-deployment">Roll back a deployment</h3>
<p>When the Grafana deployment becomes unstable due to crash looping, bugs, and so on, you can roll back a deployment to an earlier version (a <code>REVISION</code>).</p>
<p>By default, Kubernetes deployment rollout history remains in the system so that you can roll back at any time. For more information, refer to <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-to-a-previous-revision" target="_blank" rel="noopener noreferrer">Rolling Back to a Previous Revision</a>.</p>
<ol>
<li>
<p>To list all possible <code>REVISION</code> values, run the following command:</p>
<pre>kubectl rollout history deployment grafana --namespace=my-grafana</pre>
</li>
<li>
<p>To roll back to a previous version, run the <code>kubectl rollout undo</code> command and provide a revision number.</p>
<p>Example: To roll back to a previous version, specify the <code>REVISION</code> number, which appears after you run the <code>kubectl rollout history deployment</code> command, in the <code>--to-revision</code> parameter.</p>
<pre>kubectl rollout undo deployment grafana --to-revision=1 --namespace=my-grafana</pre>
</li>
<li>
<p>To verify that the rollback on the cluster is successful, run the following command:</p>
<pre>kubectl rollout status deployment grafana --namespace=my-grafana</pre>
</li>
<li>
<p>Access the Grafana UI in the browser using the provided IP:Port from the command above.</p>
<p>The Grafana sign-in page appears.</p>
</li>
<li>
<p>To sign in to Grafana, enter <code>admin</code> for both the username and password.</p>
</li>
<li>
<p>In the top-right corner, click the help icon to display the version number.</p>
</li>
<li>
<p>To see the new rollout history, run the following command:</p>
<pre>kubectl rollout history deployment grafana --namespace=my-grafana</pre>
</li>
</ol>
<p>If you need to go back to any other <code>REVISION</code>, just repeat the steps above and use the correct revision number in the <code>--to-revision</code> parameter.</p>
<h2 id="provision-grafana-resources-using-configuration-files">Provision Grafana resources using configuration files</h2>
<p>Provisioning can add, update, or delete resources specified in your configuration files when Grafana starts. For detailed information, refer to 
    <a href="/docs/grafana/latest/administration/provisioning/">Grafana Provisioning</a>.</p>
<p>This section outlines general instructions for provisioning Grafana resources within Kubernetes, using a persistent volume to supply the configuration files to the Grafana pod.</p>
<ol>
<li>
<p>Add a new <code>PersistentVolumeClaim</code> to the <code>grafana.yaml</code> file.</p>
<pre>---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-provisioning-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Mi</pre>
</li>
<li>
<p>In the <code>grafana.yaml</code> file, mount the persistent volume into <code>/etc/grafana/provisioning</code> as follows.</p>
<pre>...
    volumeMounts:
      - mountPath: /etc/grafana/provisioning
        name: grafana-provisioning-pv
      ...
volumes:
  - name: grafana-provisioning-pv
    persistentVolumeClaim:
      claimName: grafana-provisioning-pvc
...</pre>
</li>
<li>
<p>Find or create the provision resources you want to add. For instance, create a <code>alerting.yaml</code> file adding a mute timing (alerting resource).</p>
<pre>apiVersion: 1
muteTimes:
  - orgId: 1
    name: MuteWeekends
    time_intervals:
      - weekdays: [saturday, sunday]</pre>
</li>
<li>
<p>By default, configuration files for alerting resources need to be placed in the <code>provisioning/alerting</code> directory.</p>
<p>Save the <code>alerting.yaml</code> file in a directory named <code>alerting</code>, as we will next supply this <code>alerting</code> directory to the <code>/etc/grafana/provisioning</code> folder of the Grafana pod.</p>
</li>
<li>
<p>Verify first the content of the provisioning directory in the running Grafana pod.</p>
<pre>kubectl exec -n my-grafana &lt;pod_name&gt; -- ls /etc/grafana/provisioning/</pre>
<pre>kubectl exec -n my-grafana &lt;pod_name&gt; -- ls /etc/grafana/provisioning/alerting</pre>
<p>Because the <code>alerting</code> folder is not available yet, the last command should output a <code>No such file or directory</code> error.</p>
</li>
<li>
<p>Copy the local <code>alerting</code> directory to <code>/etc/grafana/provisioning/</code> in the Grafana pod.</p>
<pre>kubectl cp alerting my-grafana/&lt;pod_name&gt;:/etc/grafana/provisioning/</pre>
<p>You can follow the same process to provision additional Grafana resources by supplying the following folders:</p>
<ul>
<li><code>provisioning/dashboards</code></li>
<li><code>provisioning/datasources</code></li>
<li><code>provisioning/plugins</code></li>
</ul>
</li>
<li>
<p>Verify the <code>alerting</code> directory in the running Grafana pod includes the <code>alerting.yaml</code> file.</p>
<pre>kubectl exec -n my-grafana &lt;pod_name&gt; -- ls /etc/grafana/provisioning/alerting</pre>
</li>
<li>
<p>Restart the Grafana pod to provision the resources.</p>
<pre>kubectl rollout restart -n my-grafana deployment --selector=app=grafana</pre>
<p>Note that <code>rollout restart</code> kills the previous pod and scales a new pod. When the old pod terminates, you may have to enable port-forwarding in the new pod. For instructions, refer to the previous sections about port forwarding in this guide.</p>
</li>
<li>
<p>Verify the Grafana resources are properly provisioned within the Grafana instance.</p>
</li>
</ol>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>This section includes troubleshooting tips you might find helpful when deploying Grafana on Kubernetes.</p>
<h3 id="collecting-logs">Collecting logs</h3>
<p>It is important to view the Grafana server logs while troubleshooting any issues.</p>
<ol>
<li>
<p>To check the Grafana logs, run the following command:</p>
<pre># dump Pod logs for a Deployment (single-container case)
kubectl logs --namespace=my-grafana deploy/grafana</pre>
</li>
<li>
<p>If you have multiple containers running in the deployment, run the following command to obtain the logs only for the Grafana deployment:</p>
<pre># dump Pod logs for a Deployment (multi-container case)
kubectl logs --namespace=my-grafana deploy/grafana -c grafana</pre>
</li>
</ol>
<p>For more information about accessing Kubernetes application logs, refer to <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/#interacting-with-running-pods" target="_blank" rel="noopener noreferrer">Pods</a> and <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/#interacting-with-deployments-and-services" target="_blank" rel="noopener noreferrer">Deployments</a>.</p>
<h3 id="increasing-log-levels-to-debug-mode">Increasing log levels to debug mode</h3>
<p>By default, the Grafana log level is set to <code>info</code>, but you can increase it to <code>debug</code> mode to fetch information needed to diagnose and troubleshoot a problem. For more information about Grafana log levels, refer to <a href="/docs/grafana/latest/setup-grafana/configure-grafana/#log">Configuring logs</a>.</p>
<p>The following example uses the Kubernetes ConfigMap which is an API object that stores non-confidential data in key-value pairs. For more information, refer to <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">Kubernetes ConfigMap Concept</a>.</p>
<ol>
<li>
<p>Create a empty file and name it <code>grafana.ini</code> and add the following:</p>
<pre>[log]
; # Either &#34;debug&#34;, &#34;info&#34;, &#34;warn&#34;, &#34;error&#34;, &#34;critical&#34;, default is &#34;info&#34;
; # we change from info to debug level
level = debug</pre>
<p>This example adds the portion of the log section from the configuration file. You can refer to the <a href="/docs/grafana/latest/setup-grafana/configure-grafana/">Configure Grafana</a> documentation to view all the default configuration settings.</p>
</li>
<li>
<p>To add the configuration file into the Kubernetes cluster via the ConfigMap object, run the following command:</p>
<pre>kubectl create configmap ge-config --from-file=/path/to/file/grafana.ini --namespace=my-grafana</pre>
</li>
<li>
<p>To verify the ConfigMap object creation, run the following command:</p>
<pre>kubectl get configmap --namespace=my-grafana</pre>
</li>
<li>
<p>Open the <code>grafana.yaml</code> file and In the Deployment section, provide the mount path to the custom configuration (<code>/etc/grafana</code>) and reference the newly created ConfigMap for it.</p>
<pre>---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: grafana
  name: grafana
# the rest of the code remains the same.
...
....
...
            requests:
            cpu: 250m
            memory: 750Mi
        volumeMounts:
          - mountPath: /var/lib/grafana
            name: grafana-pv
           # This is to mount the volume for the custom configuration
          - mountPath: /etc/grafana
            name: ge-config
    volumes:
      - name: grafana-pv
        persistentVolumeClaim:
          claimName: grafana-pvc
       # This is to provide the reference to the ConfigMap for the volume
      - name: ge-config
        configMap:
          name: ge-config</pre>
</li>
<li>
<p>Deploy the manifest using the following kubectl apply command:</p>
<pre>kubectl apply -f grafana.yaml --namespace=my-grafana</pre>
</li>
<li>
<p>To verify the status, run the following commands:</p>
<pre># first check the rollout status
kubectl rollout status deployment grafana --namespace=my-grafana

# then check the deployment and configMap information
kubectl get all --namespace=my-grafana</pre>
</li>
<li>
<p>To verify it, access the Grafana UI in the browser using the provided IP:Port</p>
<p>The Grafana sign-in page appears.</p>
</li>
<li>
<p>To sign in to Grafana, enter <code>admin</code> for both the username and password.</p>
</li>
<li>
<p>Navigate to <strong>Server Admin &gt; Settings</strong> and then search for log.</p>
<p>You should see the level to debug mode.</p>
</li>
</ol>
<h3 id="using-the-dry-run-command">Using the &ndash;dry-run command</h3>
<p>You can use the Kubernetes <code>--dry-run</code> command to send requests to modifying endpoints and determine if the request would have succeeded.</p>
<p>Performing a dry run can be useful for catching errors or unintended consequences before they occur. For more information, refer to <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-api-machinery/576-dry-run/README.md" target="_blank" rel="noopener noreferrer">Kubernetes Dry-run</a>.</p>
<p>Example:</p>
<p>The following example shows how to perform a dry run when you make changes to the <code>grafana.yaml</code> such as using a new image version, or adding new labels and you want to determine if there are syntax errors or conflicts.</p>
<p>To perform a dry run, run the following command:</p>
<pre>kubectl apply -f grafana.yaml --dry-run=server --namespace=grafana</pre>
<p>If there are no errors, then the output will look similar to this:</p>
<pre>persistentvolumeclaim/grafana-pvc unchanged (server dry run)
deployment.apps/grafana unchanged (server dry run)
service/grafana unchanged (server dry run)</pre>
<p>If there are errors or warnings, you will see them in the terminal.</p>
<h2 id="remove-grafana">Remove Grafana</h2>
<p>If you want to remove any of the Grafana deployment objects, use the <code>kubectl delete command</code>.</p>
<ol>
<li>
<p>If you want to remove the complete Grafana deployment, run the following command:</p>
<pre>kubectl delete -f grafana.yaml --namespace=my-grafana</pre>
<p>This command deletes the deployment, persistentvolumeclaim, and service objects.</p>
</li>
<li>
<p>To delete the ConfigMap, run the following command:</p>
<pre>kubectl delete configmap ge-config --namespace=my-grafana</pre>
</li>
</ol>
<h2 id="deploy-grafana-enterprise-on-kubernetes">Deploy Grafana Enterprise on Kubernetes</h2>
<p>The process for deploying Grafana Enterprise is almost identical to the preceding process, except for additional steps that are required for adding your license file.</p>
<h3 id="obtain-grafana-enterprise-license">Obtain Grafana Enterprise license</h3>
<p>To run Grafana Enterprise, you need a valid license.
To obtain a license, <a href="/contact?about=grafana-enterprise">contact a Grafana Labs representative</a>.
This topic assumes that you have a valid license in a <code>license.jwt</code> file.
Associate your license with a URL that you can use later in the topic.</p>
<h3 id="create-license-secret">Create license secret</h3>
<p>Create a Kubernetes secret from your license file using the following command:</p>
<pre>kubectl create secret generic ge-license --from-file=/path/to/your/license.jwt</pre>
<h3 id="create-grafana-enterprise-configuration">Create Grafana Enterprise configuration</h3>
<ol>
<li>
<p>Create a Grafana configuration file with the name <code>grafana.ini</code></p>
</li>
<li>
<p>Paste the following YAML contents into the file you created:</p>
<pre>[enterprise]
license_path = /etc/grafana/license/license.jwt
[server]
root_url =/your/license/root/url</pre>
</li>
<li>
<p>Update the <code>root_url</code> field to the url associated with the license provided to you.</p>
</li>
</ol>
<h3 id="create-configmap-for-grafana-enterprise-configuration">Create Configmap for Grafana Enterprise configuration</h3>
<p>Create a Kubernetes Configmap from your <code>grafana.ini</code> file with the following command:</p>
<pre>kubectl create configmap ge-config --from-file=/path/to/your/grafana.ini</pre>
<h3 id="create-grafana-enterprise-kubernetes-manifest">Create Grafana Enterprise Kubernetes manifest</h3>
<ol>
<li>
<p>Create a <code>grafana.yaml</code> file, and copy-and-paste the following content into it.</p>
<p>The following YAML is identical to the one for a Grafana installation, except for the additional references to the Configmap that contains your Grafana configuration file and the secret that has your license.</p>
<pre>---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: grafana
  name: grafana
spec:
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472
        supplementalGroups:
          - 0
      containers:
        - image: grafana/grafana-enterprise:latest
          imagePullPolicy: IfNotPresent
          name: grafana
          ports:
            - containerPort: 3000
              name: http-grafana
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /robots.txt
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 2
          resources:
            limits:
              memory: 4Gi
            requests:
              cpu: 100m
              memory: 2Gi
          volumeMounts:
            - mountPath: /var/lib/grafana
              name: grafana-pv
            - mountPath: /etc/grafana
              name: ge-config
            - mountPath: /etc/grafana/license
              name: ge-license
      volumes:
        - name: grafana-pv
          persistentVolumeClaim:
            claimName: grafana-pvc
        - name: ge-config
          configMap:
            name: ge-config
        - name: ge-license
          secret:
            secretName: ge-license
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  ports:
    - port: 3000
      protocol: TCP
      targetPort: http-grafana
  selector:
    app: grafana
  sessionAffinity: None
  type: LoadBalancer</pre>


<div class="admonition admonition-caution"><blockquote><p class="title text-uppercase">Caution</p><p>If you use <code>LoadBalancer</code> in the Service and depending on your cloud platform and network configuration, doing so might expose your Grafana instance to the Internet. To eliminate this risk, use <code>ClusterIP</code> to restrict access from within the cluster Grafana is deployed to.</p></blockquote></div>

</li>
<li>
<p>To send the manifest to Kubernetes API Server, run the following command:
<code>kubectl apply -f grafana.yaml</code></p>
</li>
<li>
<p>To verify the manifest was sent, run the following command:
<code>kubectl port-forward service/grafana 3000:3000</code></p>
</li>
<li>
<p>Navigate to <code>localhost:3000</code> in your browser.</p>
<p>You should see the Grafana login page.</p>
</li>
<li>
<p>Use <code>admin</code> for both the username and password to login.</p>
</li>
<li>
<p>To verify you are working with an enterprise license, scroll to the bottom of the page where you should see <code>Enterprise (Licensed)</code>.</p>
</li>
</ol>
