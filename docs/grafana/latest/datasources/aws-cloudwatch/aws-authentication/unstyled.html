<!DOCTYPE html>
<h1 id="configure-aws-authentication">Configure AWS authentication</h1>
<p>A Grafana data source plugin&rsquo;s requests to AWS are made on behalf of an AWS Identity and Access Management (IAM) <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" target="_blank" rel="noopener noreferrer">role</a> or IAM <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html" target="_blank" rel="noopener noreferrer">user</a>.
The IAM user or IAM role must have the associated policies to perform certain API actions to query the data in the data source.
Since these policies are specific to each data source, refer to each data source plugin&rsquo;s documentation for details.</p>
<p>All requests to AWS APIs are performed on the server side by the Grafana backend using the official <a href="https://github.com/aws/aws-sdk-go" target="_blank" rel="noopener noreferrer">AWS SDK</a>.</p>
<p>This topic has the following sections:</p>
<ul>
<li><a href="#select-an-authentication-method">Select an authentication method</a></li>
<li><a href="#assume-a-role">Assume a role</a></li>
<li><a href="#use-a-custom-endpoint">Use a custom endpoint</a></li>
<li><a href="#use-an-aws-credentials-file">Use an AWS credentials file</a></li>
<li><a href="#use-eks-iam-roles-for-service-accounts">Use EKS IAM roles for service accounts</a></li>
</ul>
<h2 id="select-an-authentication-method">Select an authentication method</h2>
<p>Depending on your configuration and the environment your instance of Grafana is running in, you&rsquo;ll have different authentication methods to select from.</p>
<p>Open source Grafana enables the <code>AWS SDK Default</code>, <code>Credentials file</code>, and <code>Access and secret key</code> methods by default. Cloud Grafana enables <code>Access and secret key</code> by default. If necessary, you can enable or disable particular auth providers if you have server configuration access. For more information, refer to the 
    <a href="/docs/grafana/latest/setup-grafana/configure-grafana/#allowed_auth_providers"><code>allowed_auth_providers</code> documentation</a>.</p>
<ul>
<li><code>AWS SDK Default</code> performs no custom configuration and instead uses the <a href="https://docs.aws.amazon.com/sdk-for-go/v1/developer-guide/configuring-sdk.html" target="_blank" rel="noopener noreferrer">default provider</a> as specified by the <a href="https://github.com/aws/aws-sdk-go" target="_blank" rel="noopener noreferrer">AWS SDK for Go</a>.
It requires you to configure your AWS credentials outside of grafana, such as with <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" target="_blank" rel="noopener noreferrer">the CLI</a>, or by <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html" target="_blank" rel="noopener noreferrer">attaching credentials directly to an EC2 instance</a>, <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html" target="_blank" rel="noopener noreferrer">in an ECS task</a>, or for a <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="noopener noreferrer">Service Account in a Kubernetes cluster</a>. With <code>AWS SDK Default</code> you can attach permissions directly to the data source or you can use it combination with the optional <a href="#assume-a-role"><code>Assume Role ARN</code></a> field.</li>
<li><code>Credentials file</code> corresponds directly to the <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/credentials/#SharedCredentialsProvider" target="_blank" rel="noopener noreferrer">SharedCredentialsProvider</a> provider in the <a href="https://github.com/aws/aws-sdk-go" target="_blank" rel="noopener noreferrer">AWS SDK for Go</a>.
It reads the AWS shared credentials file to find a given profile.
While <code>AWS SDK Default</code> will also find the shared credentials file, this option allows you to specify which profile to use without using environment variables.
This option doesn&rsquo;t have any implicit fallbacks to other credential providers, and it fails if the credentials provided from the file aren&rsquo;t correct.</li>
<li><code>Access and secret key</code> corresponds to the <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/credentials/#StaticProvider" target="_blank" rel="noopener noreferrer">StaticProvider</a> and uses the given access key ID and secret key to authenticate.
This method doesn&rsquo;t have any fallbacks, and will fail if the provided key pair doesn&rsquo;t work. This is the primary authentication method for Grafana Cloud.</li>
<li><code>Grafana Assume Role</code> - With this auth provider option, Grafana Cloud users create an AWS IAM role that has a trust relationship with Grafana&rsquo;s AWS account. Grafana then uses <a href="https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html" target="_blank" rel="noopener noreferrer">STS</a> to generate temporary credentials on its behalf. Users with this option enabled no longer need to generate secret and access keys for users. Refer to <a href="/docs/grafana/latest/datasources/aws-cloudwatch/aws-authentication/#use-grafana-assume-role">Use Grafana Assume Role</a> for further detail.</li>
<li><code>Workspace IAM role</code> corresponds to the <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/credentials/ec2rolecreds/#EC2RoleProvider" target="_blank" rel="noopener noreferrer">EC2RoleProvider</a>.
The EC2RoleProvider pulls credentials for a role attached to the EC2 instance that Grafana runs on.
You can also achieve this by using the authentication method AWS SDK Default, but this option is different as it doesn&rsquo;t have any fallbacks.
This option is enabled by default only in Amazon Managed Grafana.</li>
</ul>
<h2 id="assume-a-role">Assume a role</h2>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Assume a role is required for the Grafana Assume Role.</p></blockquote></div>

<p>You can specify an IAM role to assume in the <strong>Assume Role ARN</strong> field.</p>
<p>When this field is filled in, Grafana uses the provided credentials to perform an <a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html" target="_blank" rel="noopener noreferrer">sts:AssumeRole</a> call. In this scenario, the primary authentication method does not need permission to access CloudWatch directly; it just needs the ability to assume a role, while the role it assumes should have permission to access CloudWatch.</p>
<p>For example, you may have one set of long term credentials for all of your AWS data sources. However, you want to limit the access each data source has to AWS (maybe one accesses staging data and another production data, for example). You could create separate credentials for each data source, each maintaining its own set of permissions to various resources. However, depending on how many data sources instances you have and how you&rsquo;ve set them up, that might mean rotating and managing many different secret and access keys.</p>
<p>Instead, using the assume role functionality, you could have one set of AWS credentials for all of your AWS data sources that has only one permissionâ€”the permission to assume a role with STS. Then you could create a separate IAM role for each data source that specifies which permissions that data source can temporarily assume. Since IAM roles are not credentials, there&rsquo;s no need to rotate them and they may be easier to manage.</p>
<p>The Grafana Assume Role also helps facilitate this. Using this role, Grafana&rsquo;s AWS account acts as the primary credential, having only the permission to assume roles in other accounts. You can then create IAM roles for Grafana&rsquo;s account to assume. For more information, refer to <a href="#use-grafana-assume-role">Use Grafana assume role</a>.</p>
<p>If the <strong>Assume Role ARN</strong> field is left empty, Grafana uses the provided credentials from the selected authentication method directly, and permissions to AWS data must be attached directly to those credentials. The <strong>Assume Role ARN</strong> field is optional for all authentication methods except for Grafana Assume Role.</p>
<p>To disable this feature in open source Grafana or Grafana Enterprise, refer to the 
    <a href="/docs/grafana/latest/setup-grafana/configure-grafana/#assume_role_enabled"><code>assume_role_enabled</code> documentation</a>.</p>
<h3 id="use-an-external-id">Use an external ID</h3>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>You cannot use an external ID for the Grafana Assume Role authentication provider.</p></blockquote></div>

<p>To assume a role in another account that was created with an external ID, specify the external ID in the <strong>External ID</strong> field.</p>
<p>For more information, refer to the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html" target="_blank" rel="noopener noreferrer">AWS documentation on external ID</a>.</p>
<p>When Grafana Assume Role is the selected authentication provider, Grafana is responsible for supplying and calling the external ID. It&rsquo;s displayed on the data source configuration page and is unique to your account. It&rsquo;s very important when creating an IAM role for <code>Grafana Assume Role</code> that you set a conditional that Grafana&rsquo;s AWS account can only assume your IAM role when a particular external ID is specified:</p>
<pre>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;AWS&#34;: {Grafana&#39;s AWS Account}
            },
            &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
            &#34;Condition&#34;: {
                &#34;StringEquals&#34;: {
                    &#34;sts:ExternalId&#34;: {External ID unique to your account}
                }
            }
        }
    ]
}</pre>
<h2 id="use-a-custom-endpoint">Use a custom endpoint</h2>
<p>You can specify a custom endpoint URL in the <strong>Endpoint</strong> field, which overrides the default generated endpoint for the AWS service API.
Leave this field blank to use the default generated endpoint.</p>
<p>For more information on why and how to use service endpoints, refer to the <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html" target="_blank" rel="noopener noreferrer">AWS service endpoints documentation</a>.</p>
<h2 id="use-an-aws-credentials-file">Use an AWS credentials file</h2>
<p>Create a file at <code>~/.aws/credentials</code>, the <code>HOME</code> path for the user running the <code>grafana-server</code> service.</p>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>If you think you have the credentials file in the right location, but it&rsquo;s not working, try moving your <code>.aws</code> file to <code>/usr/share/grafana/</code> and grant your credentials file at most 0644 permissions.</p></blockquote></div>

<h3 id="credentials-file-example">Credentials file example</h3>
<pre>[default]
aws_access_key_id = asdsadasdasdasd
aws_secret_access_key = dasdasdsadasdasdasdsa
region = us-west-2</pre>
<h2 id="use-eks-iam-roles-for-service-accounts">Use EKS IAM roles for service accounts</h2>
<p>The Grafana process in the container runs as user 472 (called &ldquo;grafana&rdquo;).
When Kubernetes mounts your projected credentials, they&rsquo;re available by default to only the root user.</p>
<p>To grant user 472 permission to access the credentials, and avoid falling back to the IAM role attached to the EC2 instance, you must provide a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener noreferrer">security context</a> for your pod.</p>
<h3 id="security-context-example">Security context example</h3>
<pre>securityContext:
  fsGroup: 472
  runAsUser: 472
  runAsGroup: 472</pre>
<h2 id="use-grafana-assume-role">Use Grafana Assume Role</h2>


<div class="admonition admonition-note"><blockquote><p class="title text-uppercase">Note</p><p>Grafana Assume Role is only available in Grafana Cloud.</p>
<p>It&rsquo;s currently only available for Amazon CloudWatch and Athena.</p></blockquote></div>

<p>The Grafana Assume Role authentication provider lets you authenticate with AWS without having to create and maintain long term AWS users or rotate their access and secret keys. Instead, you can create an IAM role that has permissions to access CloudWatch and a trust relationship with Grafana&rsquo;s AWS account. Grafana&rsquo;s AWS account then makes an STS request to AWS to create temporary credentials to access your AWS data. It makes this STS request by passing along an <code>externalID</code> that&rsquo;s unique per Cloud account, to ensure that Grafana Cloud users can only access their own AWS data. For more information, refer to the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html" target="_blank" rel="noopener noreferrer">AWS documentation on external ID</a>.</p>
<p>To use the Grafana Assume Role:</p>
<ol>
<li>Create a new CloudWatch data source (or update an existing one) and select <strong>Grafana Assume Role</strong> as an authentication provider.</li>
<li>In the AWS Console, create a new IAM role, and under <strong>Trusted entity type</strong>, select <strong>Another AWS account</strong> as the trusted Entity.</li>
<li>Enter the Grafana account id (displayed in the instructions box on the <strong>Settings</strong> tab of the CloudWatch data source configuration) and check the <strong>Require external ID</strong> box.</li>
<li>Enter the external ID specified in the instructions box on the <strong>Settings</strong> tab of the CloudWatch data source configuration in Grafana. This external ID will be unique to your Grafana instance.</li>
<li>Attach any required permissions you would like Grafana to be able to access on your behalf (for example, CloudWatch Logs and CloudWatch Metrics policies).</li>
<li>Give the role a name and description, and click <strong>Create role</strong>.</li>
<li>Copy the ARN of the role you just created and paste it into the <strong>Assume Role ARN</strong> field on the <strong>Settings</strong> tab of CloudWatch data source configuration in Grafana.</li>
</ol>
<p>Sample Trust Relationship for an IAM role:</p>
<pre>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;AWS&#34;: {Grafana&#39;s AWS Account}
            },
            &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
            &#34;Condition&#34;: {
                &#34;StringEquals&#34;: {
                    &#34;sts:ExternalId&#34;: {External ID unique to your account}
                }
            }
        }
    ]
}</pre>
